<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>双红会：曼联 vs 利物浦</title>

<!-- ECharts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
<!-- 引入外部 CSS -->
<link rel="stylesheet" href="bigred.css">

</head>
<body>

<a href="../main.html#derby-section-container" style="position: fixed; top: 20px; left: 20px; z-index: 9999; color: #fff; text-decoration: none; font-weight: bold; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); font-family: sans-serif;">
    &larr; Back
</a>

  <div class="page-wrap">
    <div class="panel">

      <!-- 顶部 Banner -->
      <div class="top-banner">
        <div class="team-badge" title="Manchester United">
          <img src="./pic/manu.svg" alt="Man Utd Badge">
        </div>

        <div class="banner-center">
          <div class="banner-title">双红会</div>
          <div class="banner-sub">Manchester United vs Liverpool</div>
          <div class="banner-sub">十赛季数据汇总</div>

          <!-- 战术板 overlay -->
          <svg class="tactics-overlay" viewBox="0 0 1200 160" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0" stop-color="#F3D459" stop-opacity="0.3" />
                <stop offset="1" stop-color="#DA291C" stop-opacity="0" />
              </linearGradient>
            </defs>
            <g stroke="url(#g1)" stroke-width="2" fill="none">
              <path d="M40 100 C 250 20, 450 20, 600 90" stroke-linecap="round" />
              <path d="M1200 100 C 950 20, 750 20, 600 90" stroke-linecap="round" transform="scale(-1,1) translate(-1200,0)"/>
              <circle cx="600" cy="56" r="10" fill="#fff" opacity="0.18"/>
              <circle cx="600" cy="56" r="4" fill="#F3D459" opacity="0.95"/>
            </g>
          </svg>

        </div>

        <div class="team-badge" title="Liverpool">
          <img src="./pic/liv.jpg" alt="Liverpool Badge" />
        </div>
      </div>

      <!-- 内容网格 -->
      <div class="content-grid" style="margin-top:18px;">
        <!-- Card 1: Goals -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">进球趋势（10赛季）</div>
              <div class="card-sub">金色 = 曼联 · 红色 = 利物浦</div>
            </div>
            <div class="chip">进攻</div>
          </div>
          <div class="chart" id="goalsChart"></div>
          <div class="metal-strip"></div>
        </div>

        <!-- Card 2: Ranking -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">联赛排名（数值越小越优）</div>
              <div class="card-sub">反映赛季稳定性与走势</div>
            </div>
            <div class="chip">排名</div>
          </div>
          <div class="chart" id="rankingChart"></div>
          <div class="metal-strip"></div>
        </div>

        <!-- Wide Card: Conflict -->
        <div class="card wide" style="overflow:visible">
          <div class="card-header">
            <div>
              <div class="card-title">火爆指数 · 红黄牌 & 胜负占比</div>
              <div class="card-sub">英格兰国家德比的激烈程度</div>
            </div>
            <div class="chip">纪律 & 胜率</div>
          </div>

          <div style="display:flex;gap:18px;align-items:stretch">
            <div id="fightChart" class="chart" style="flex:1"></div>
          </div>
          <div class="metal-strip"></div>
        </div>

        <!-- New Wide Card: Possession Comparison -->
        <div class="card wide">
          <div class="card-header">
            <div>
              <div class="card-title">控球率博弈（赛季均值 vs 德比实战）</div>
              <div class="card-sub">虚线：赛季平均 · 实心点：主场德比 · 空心点：客场德比</div>
            </div>
            <div class="chip">战术控制</div>
          </div>
          <div class="chart" id="possessionChart"></div>
          <div class="metal-strip"></div>
        </div>

      </div> <!-- content-grid end -->

    </div>
  </div>

  <script type="module">
  import derbyData from './bigred.js';

  // ============================
  // 数据处理
  // ============================
  
  // 1. 按时间正序排列
  const sortedData = [...derbyData].reverse();

  const seasons = sortedData.map(d => d.season);
  
  const manGoals = [];
  const livGoals = [];
  const manRanking = [];
  const livRanking = [];

  // 控球率数据
  const manSeasonAvgPoss = [];
  const livSeasonAvgPoss = [];
  const manHomeDerbyPoss = []; // 曼联在主场(Old Trafford)的控球率
  const manAwayDerbyPoss = []; // 曼联在客场(Anfield)的控球率
  const livHomeDerbyPoss = []; // 利物浦在主场(Anfield)的控球率
  const livAwayDerbyPoss = []; // 利物浦在客场(Old Trafford)的控球率

  let manYellow = 0, livYellow = 0;
  let manRed = 0, livRed = 0;
  let manWins = 0, livWins = 0, draws = 0;

  sortedData.forEach(d => {
    // 排名 & 赛季平均控球率
    const manSum = d.seasonSummary.find(t => t.team === 'Manchester United');
    const livSum = d.seasonSummary.find(t => t.team === 'Liverpool');
    manRanking.push(manSum ? manSum.leaguePos : null);
    livRanking.push(livSum ? livSum.leaguePos : null);
    
    manSeasonAvgPoss.push(manSum ? manSum.avg_possession : null);
    livSeasonAvgPoss.push(livSum ? livSum.avg_possession : null);

    // 统计该赛季两队相互比赛的进球与红黄牌
    let mGoals = 0;
    let lGoals = 0;
    
    // 临时存储当季德比控球率
    let mhp = null, map = null, lhp = null, lap = null;

    d.matches.forEach(m => {
      // 解析比分 "HomeName Score-Score AwayName"
      const scoreMatch = m.score.match(/(\d+)-(\d+)/);
      if(!scoreMatch) return;
      
      const scoreHome = parseInt(scoreMatch[1], 10);
      const scoreAway = parseInt(scoreMatch[2], 10);

      // 判断主客场 (Old Trafford 为曼联主场)
      const isManHome = m.venue === 'Old Trafford';

      if(isManHome) {
        // 曼联主场
        mGoals += scoreHome;
        lGoals += scoreAway;
        
        manYellow += m.yellow_cards.home;
        livYellow += m.yellow_cards.away;
        manRed += m.red_cards.home;
        livRed += m.red_cards.away;

        if(scoreHome > scoreAway) manWins++;
        else if(scoreHome < scoreAway) livWins++;
        else draws++;

        // 控球率
        if(m.possession) {
          mhp = m.possession.home; // 曼联主场控球
          lap = m.possession.away; // 利物浦客场控球
        }

      } else {
        // 利物浦主场
        lGoals += scoreHome;
        mGoals += scoreAway;

        livYellow += m.yellow_cards.home;
        manYellow += m.yellow_cards.away;
        livRed += m.red_cards.home;
        manRed += m.red_cards.away;

        if(scoreHome > scoreAway) livWins++;
        else if(scoreHome < scoreAway) manWins++;
        else draws++;

        // 控球率
        if(m.possession) {
          lhp = m.possession.home; // 利物浦主场控球
          map = m.possession.away; // 曼联客场控球
        }
      }
    });

    manGoals.push(mGoals);
    livGoals.push(lGoals);
    
    manHomeDerbyPoss.push(mhp);
    manAwayDerbyPoss.push(map);
    livHomeDerbyPoss.push(lhp);
    livAwayDerbyPoss.push(lap);
  });

  // 配色定义
  const COLOR_MAN = '#F3D459'; // 曼联金
  const COLOR_LIV = '#DA291C'; // 利物浦红
  const COLOR_DRAW = '#BFBFBF';

  const cardsData = [
    { name:'曼联 黄牌', value:manYellow, itemStyle:{color:COLOR_MAN} },
    { name:'利物浦 黄牌', value:livYellow, itemStyle:{color:COLOR_LIV} },
    { name:'曼联 红牌', value:manRed, itemStyle:{color:'#B8860B'} }, // 深金
    { name:'利物浦 红牌', value:livRed, itemStyle:{color:'#800000'} }  // 深红
  ];
  const winLoseData = [
    { name:'曼联 胜', value:manWins, itemStyle:{color:COLOR_MAN} },
    { name:'利物浦 胜', value:livWins, itemStyle:{color:COLOR_LIV} },
    { name:'平局', value:draws, itemStyle:{color:COLOR_DRAW} }
  ];

  // ============================
  // 初始化 ECharts
  // ============================
  const goalsChart = echarts.init(document.getElementById('goalsChart'),'dark');
  const rankingChart = echarts.init(document.getElementById('rankingChart'),'dark');
  const fightChart = echarts.init(document.getElementById('fightChart'),'dark');
  const possessionChart = echarts.init(document.getElementById('possessionChart'),'dark');

  const commonTooltip = {
    backgroundColor: 'rgba(10,10,12,0.95)',
    borderColor: '#DDDDDD',
    borderWidth: 1,
    padding:10,
    textStyle: { color:'#fff' },
    extraCssText: 'box-shadow: 0 6px 20px rgba(0,0,0,0.6); border-radius:8px;'
  };

  // ============================
  // 进球趋势
  // ============================
  const goalsOption = {
    tooltip: Object.assign({ trigger:'axis' }, commonTooltip),
    legend: {
      data: ['曼联','利物浦'],
      top:8,
      textStyle:{ color:'#fff' }
    },
    grid: { left: '6%', right:'6%', top:'16%', bottom:'12%', containLabel:true },
    xAxis: {
      type:'category',
      data:seasons,
      axisLine:{ lineStyle:{ color:'rgba(255,255,255,0.12)'}},
      axisLabel:{ color:'#ddd' }
    },
    yAxis: {
      type:'value',
      axisLine:{ lineStyle:{ color:'rgba(255,255,255,0.12)'}},
      axisLabel:{ color:'#ddd' },
      splitLine:{ lineStyle:{ color:'rgba(255,255,255,0.03)'} }
    },
    series: [
      {
        name:'曼联',
        type:'line',
        data:manGoals,
        smooth:true,
        symbol:'circle',
        symbolSize:8,
        lineStyle:{ width:3, color:COLOR_MAN, shadowColor:COLOR_MAN, shadowBlur:10 },
        itemStyle:{ color:COLOR_MAN },
        emphasis:{ focus:'series', scale:true }
      },
      {
        name:'利物浦',
        type:'line',
        data:livGoals,
        smooth:true,
        symbol:'diamond',
        symbolSize:8,
        lineStyle:{ width:3, color:COLOR_LIV, opacity:0.95, shadowColor:COLOR_LIV, shadowBlur:8 },
        itemStyle:{ color:COLOR_LIV },
        emphasis:{ focus:'series', scale:true }
      }
    ]
  };

  // ============================
  // 排名
  // ============================
  const rankingOption = {
    tooltip: Object.assign({ trigger:'axis', formatter: (params) => {
      const p = params[0];
      return `${p.axisValue}<br/>${p.seriesName}：第${p.value}名`;
    } }, commonTooltip),
    legend:{ data:['曼联','利物浦'], top:8, textStyle:{color:'#fff'} },
    grid: { left:'6%', right:'6%', top:'16%', bottom:'12%', containLabel:true },
    xAxis:{ type:'category', data:seasons, axisLine:{lineStyle:{color:'rgba(255,255,255,0.12)'}}, axisLabel:{color:'#ddd'} },
    yAxis:{ type:'value', inverse:true, min:0, max:20, axisLine:{lineStyle:{color:'rgba(255,255,255,0.12)'}}, axisLabel:{color:'#ddd'}, splitLine:{lineStyle:{color:'rgba(255,255,255,0.03)'}} },
    series:[
      {
        name:'曼联',
        type:'bar',
        data:manRanking,
        barWidth: '34%',
        itemStyle:{ color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:'#FFFACD'},{offset:1,color:COLOR_MAN}]) },
        emphasis:{ itemStyle:{ opacity:0.9 } },
        label:{ show:true, position:'top', color:'#fff', fontSize:11 }
      },
      {
        name:'利物浦',
        type:'bar',
        data:livRanking,
        barWidth: '34%',
        itemStyle:{ color: COLOR_LIV },
        emphasis:{ itemStyle:{ opacity:0.95 } },
        label:{ show:true, position:'top', color:'#fff' }
      }
    ]
  };

  // ============================
  // 火爆指数
  // ============================
  const fightOption = {
    tooltip: Object.assign({ trigger:'item' }, commonTooltip),
    legend:{ bottom:10, textStyle:{color:'#fff'} },
    series: [
      {
        name:'红黄牌',
        type:'pie',
        radius:['22%','38%'],
        center:['30%','50%'],
        data: cardsData.map(d => ({...d})),
        label: { color:'#fff', formatter: '{b}\n{c} 张' },
        emphasis: { itemStyle:{ shadowBlur:30, shadowColor:'#ffd700' } }
      },
      {
        name:'胜负占比',
        type:'pie',
        radius:['22%','38%'],
        center:['70%','50%'],
        data: winLoseData.map(d => ({...d})),
        label: { color:'#fff', formatter: '{b}\n{c} 场' },
        emphasis: { itemStyle:{ shadowBlur:30, shadowColor:'#ffd700' } }
      }
    ]
  };

  // ============================
  // 控球率对比
  // ============================
  const possessionOption = {
    tooltip: Object.assign({ trigger:'item', formatter: (params) => {
      return `${params.seriesName}<br/>${params.name}：${params.value}%`;
    } }, commonTooltip),
    legend: { 
      data:['曼联(赛季均值)','利物浦(赛季均值)','曼联(主场德比)','曼联(客场德比)','利物浦(主场德比)','利物浦(客场德比)'], 
      top:8, 
      textStyle:{color:'#fff', fontSize:11},
      itemWidth: 12,
      itemHeight: 8
    },
    grid: { left: '4%', right:'4%', top:'20%', bottom:'12%', containLabel:true },
    xAxis: { 
      type:'category', 
      data:seasons, 
      axisLine:{ lineStyle:{ color:'rgba(255,255,255,0.12)'}}, 
      axisLabel:{ color:'#ddd' } 
    },
    yAxis: { 
      type:'value', 
      name:'控球率(%)',
      min: 30, max: 70,
      axisLine:{ lineStyle:{ color:'rgba(255,255,255,0.12)'}},
      axisLabel:{ color:'#ddd' },
      splitLine:{ lineStyle:{ color:'rgba(255,255,255,0.03)'} } 
    },
    series: [
      // 赛季均值（虚线）
      { 
        name:'曼联(赛季均值)', 
        type:'line', 
        data:manSeasonAvgPoss, 
        smooth:true,
        itemStyle:{color:COLOR_MAN}, 
        lineStyle:{type:'dashed', width:2, opacity:0.6}, 
        symbol:'none' 
      },
      { 
        name:'利物浦(赛季均值)', 
        type:'line', 
        data:livSeasonAvgPoss, 
        smooth:true,
        itemStyle:{color:COLOR_LIV}, 
        lineStyle:{type:'dashed', width:2, opacity:0.6}, 
        symbol:'none' 
      },
      // 德比实战（散点）
      {
        name:'曼联(主场德比)',
        type:'scatter',
        data: manHomeDerbyPoss,
        itemStyle:{color:COLOR_MAN},
        symbolSize: 10,
        symbol: 'circle'
      },
      {
        name:'曼联(客场德比)',
        type:'scatter',
        data: manAwayDerbyPoss,
        itemStyle:{color:'#111', borderColor:COLOR_MAN, borderWidth:2},
        symbolSize: 10,
        symbol: 'circle'
      },
      {
        name:'利物浦(主场德比)',
        type:'scatter',
        data: livHomeDerbyPoss,
        itemStyle:{color:COLOR_LIV},
        symbolSize: 10,
        symbol: 'diamond'
      },
      {
        name:'利物浦(客场德比)',
        type:'scatter',
        data: livAwayDerbyPoss,
        itemStyle:{color:'#111', borderColor:COLOR_LIV, borderWidth:2, },
        symbolSize: 10,
        symbol: 'diamond'
      }
    ]
  };

  // 渲染图表
  goalsChart.setOption(goalsOption);
  rankingChart.setOption(rankingOption);
  fightChart.setOption(fightOption);
  possessionChart.setOption(possessionOption);

  // 自适应
  window.addEventListener('resize', () => {
    goalsChart.resize(); rankingChart.resize(); fightChart.resize(); possessionChart.resize();
  });

</script>
</body>
</html>
