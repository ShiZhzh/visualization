<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Football Stadiums Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script> <!-- Added D3.js -->
    <script src="data.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<img id="pl-logo" src="./image/pl_white.png" alt="Premier League Logo">
<div id="title">
    通过可视化带你认识“英超”
</div>
<div id="intro-text">
    英格兰足球超级联赛（Premier League），通常简称“英超”，是英格兰足球总会属下的最高等级职业足球联赛。<br>
    作为世界上最受欢迎的体育联赛之一，英超以其快节奏的比赛风格、激烈的竞争环境和顶级的球星阵容闻名于世。<br>
    这里汇聚了曼联、利物浦、阿森纳、切尔西、曼城等豪门俱乐部，每个赛季都上演着扣人心弦的冠军争夺战。<br><br>
    我们的可视化首先实现了“英超地图”，通过地图展示各俱乐部的分布以及基本情况<br>
    随后我们通过多种方法可视化了英超联赛数据，直观展示了各俱乐部特点和联赛发展
</div>
<div id="msg">

</div>
<div id="chart">
    英超地图
</div>
<div id="chart-container"></div>
<script>
    var teamsData = allTeamsData;

    const chartDom = document.getElementById('chart-container');
    const myChart = echarts.init(chartDom);

    fetch("gb.json")
        .then(response => response.json())
        .then(geoData => {
            // IDs of districts in Scotland, Wales, and Northern Ireland to exclude
            const nonEnglishIds = new Set([
                // Scotland
                "GBABD", "GBABE", "GBAGB", "GBANS", "GBCLK", "GBDGY", "GBDND", "GBEAY", "GBEDH", "GBEDU", 
                "GBELN", "GBELS", "GBFAL", "GBFIF", "GBGLG", "GBHLD", "GBIVC", "GBMLN", "GBMRY", "GBNAY", 
                "GBNLK", "GBORK", "GBPKN", "GBRFW", "GBSAY", "GBSCB", "GBSLK", "GBSTG", "GBWDU", "GBWLN", 
                "GBZET","GBERW",
                // Wales
                "GBAGY", "GBBGE", "GBBGW", "GBCAY", "GBCGN", "GBCMN", "GBCRF", "GBCWY", "GBDEN", "GBFLN", 
                "GBGWN", "GBMON", "GBMTY", "GBNTL", "GBNWP", "GBPEM", "GBPOW", "GBRCT", "GBSWA", "GBTOF", 
                "GBVGL", "GBWRX",
                // Northern Ireland
                "GBANT", "GBARD", "GBARM", "GBBLA", "GBBLY", "GBBNB", "GBBFS", "GBCKF", "GBCSR", "GBCKT", 
                "GBCLR", "GBCGV", "GBDGN", "GBDOW", "GBDRY", "GBFER", "GBLMV", "GBLRN", "GBLSB", "GBMFT", 
                "GBMYL", "GBNDN", "GBNTA", "GBNYM", "GBOMH", "GBSTB"
            ]);

            // 定义英格兰9大区的 ID 集合和对应颜色
            const regionConfig = [
                {
                    name: "North East",
                    color: "#87CEEB", // SkyBlue
                    ids: new Set(["GBNBL","GBNET","GBGAT","GBNTY","GBSTY","GBSND","GBDUR","GBDAL","GBHPL","GBSTT","GBRCC","GBMDB"])
                },
                {
                    name: "North West",
                    color: "#4682B4", // SteelBlue
                    ids: new Set(["GBCMA","GBLAN","GBBPL","GBBBD","GBBOL","GBBUR","GBMAN","GBOLD","GBROC","GBSAL","GBSKP",
                        "GBTAM","GBTRA","GBWIG","GBKNO","GBLIV","GBSEF","GBWIR","GBHAL","GBWRT","GBCHE","GBCWC","GBCHW",
                        "GBTRF","GBSFT","GBKWL","GBSHN","GBWGN","GBSLF","GBRCH",])},
                {
                    name: "Yorkshire and the Humber",
                    color: "#33FF99",
                    ids: new Set(["GBNYK","GBYOR","GBERY","GBKHU","GBBRD","GBCLD","GBKIR","GBLDS","GBWKF","GBBNS","GBDNC",
                        "GBROT","GBSHF","GBNLN","GBNEL","GBKHL",])
                },
                {
                    name: "East Midlands",
                    color: "#FFD700", // Gold
                    ids: new Set(["GBDBY","GBDER","GBNTT","GBNGM","GBLIN","GBLEC","GBLCE","GBRUT","GBNTH","GBNNH","GBWNH"])
                },
                {
                    name: "West Midlands",
                    color: "#FFA500", // Orange
                    ids: new Set(["GBSTS","GBSTO","GBSHR","GBTEL","GBWAR","GBWOR","GBHEF","GBBIR","GBCOV","GBDUD","GBSAN","GBSOL",
                        "GBWAL","GBWLV","GBWLL","GBSAW","GBTFW","GBSTE",])
                },
                {
                    name: "East of England",
                    color: "#9999FF",
                    ids: new Set(["GBNFK","GBSFK","GBCAM","GBPET","GBESS","GBSOU","GBTHR","GBHRT","GBBDF","GBLUT","GBCEN","GBCBF",
                        "GBPTE","GBSOS",])
                },
                {
                    name: "London",
                    color: "#FF9999", // OrangeRed
                    ids: new Set(["GBLND","GBBKI","GBBNE","GBBEX","GBBRN","GBBRO","GBCRO","GBEAL","GBENF","GBGRE","GBHCK",
                        "GBHMF","GBHRG","GBHRW","GBHAV","GBHIL","GBHNS","GBISL","GBKEC","GBKTT","GBLBH","GBLEW","GBMRT","GBNWM",
                        "GBRDB","GBRIC","GBSWK","GBSUT","GBTOW","GBWFT","GBWND","GBWSM","GBSTN","GBCRY","GBBRY","GBBEN","GBBDG",
                        "GBTWH","GBCMD","GBHRY",])
                },
                {
                    name: "South East",
                    color: "#40E0D0", // Turquoise
                    ids: new Set(["GBBKM","GBMKN","GBOXF","GBSUR","GBWSX","GBESX","GBBHM","GBKEN","GBMDW","GBHAM","GBPOR","GBSOU",
                        "GBIOW","GBBRK","GBBRA","GBREA","GBSLO","GBWNM","GBWIN","GBSTH","GBWBK","GBSRY","GBRDG","GBWOK", "GBBRC",
                        "GBSLG","GBMIK","GBBNH", ])
                },
                {
                    name: "South West",
                    color: "#66B2FF", // DodgerBlue
                    ids: new Set(["GBGLO","GBSGC","GBWIL","GBSWI","GBDOR","GBBOU","GBPOO","GBSOM","GBBAS","GBNSM","GBDEV","GBPLY",
                        "GBTOR","GBCRN","GBIOS","GBTOB","GBBST","GBCON","GBPOL","GBBMH","GBGLS", "GBSWD",  ])
                }
            ];

            geoData.features = geoData.features.filter(feature => !nonEnglishIds.has(feature.properties.id));

            const specialRegions = [];
            const districtToRegionMap = {}; // 新增：用于映射行政区名到大区名

            geoData.features.forEach(feature => {
                // 遍历配置，找到当前 feature 所属的区域
                const region = regionConfig.find(r => r.ids.has(feature.properties.id));
                if (region) {
                    districtToRegionMap[feature.properties.name] = region.name; // 记录映射关系
                    specialRegions.push({
                        name: feature.properties.name,
                        itemStyle: {
                            areaColor: region.color
                        }
                    });
                }
            });

            echarts.registerMap('UK', geoData);

            // 根据缩放级别动态生成数据，控制标签显示数量
            function getSeriesData(zoom) {
                let limit;
                if (zoom < 1.5) {
                    limit = 11; // 缩放很小时，只显示前5个
                } else if (zoom < 2) {
                    limit = 20; // 中等缩放时，显示前20个
                } else {
                    limit = teamsData.length; // 放大后显示全部
                }

                return teamsData.map((item, index) => ({
                    name: item.team,
                    value: [item.lon, item.lat],
                    info: item, // 传递完整信息以便 tooltip 使用
                    label: {
                        show: index < limit // 只有在前 limit 个球队中才显示标签
                    }
                }));
            }

            const option = {
                backgroundColor: 'transparent', // 背景透明，让 CSS drop-shadow 生效
                geo: {
                    map: 'UK',
                    regions: specialRegions,
                    roam: true,
                    label: {
                        show: false, // 初始不显示地区名称，防止太挤
                        color: '#999',
                        fontSize: 16
                    },
                    itemStyle: {
                        areaColor: '#f4f4f4', // 浅灰色区域
                        borderColor: '#fff',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: {
                            areaColor: '#e0e0e0', // 悬浮颜色加深
                            // 悬浮时可以保留一点微弱的阴影
                            shadowBlur: 5,
                            shadowColor: 'rgba(0,0,0,0.2)'
                        },
                        label: {
                            show: true,
                            color: '#37003c' // 悬浮文字紫色
                        }
                    }
                },
                series: [
                    {
                        name: 'Stadiums',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        data: getSeriesData(1), // 初始数据，假设默认缩放为1
                        symbolSize: 15,
                        itemStyle: {
                            color: '#ff2882', // 英超粉色点
                            borderColor: '#fff',
                            borderWidth: 2,
                            shadowBlur: 8,
                            shadowColor: 'rgba(0,0,0,0.4)'
                        },
                        label: {
                            show: true,
                            formatter: '{b}',
                            position: 'top',
                            color: '#37003c', // 标签文字紫色
                            fontWeight: 'bold',
                            fontSize: 14,
                            backgroundColor: 'rgba(255,255,255,0.8)', // 标签背景半透明白
                            padding: [4, 8],
                            borderRadius: 4
                        },
                        emphasis: {
                            scale: true,
                            label: {
                                show: true,
                                fontSize: 14,
                            }
                        }
                    }
                ],
                tooltip: {
                    trigger: 'item',
                    enterable: true, // 允许鼠标进入 tooltip
                    formatter: getTooltipFormatter()
                }
            };

            myChart.setOption(option);

            // 监听地图漫游（缩放/平移）事件
            myChart.on('georoam', function () {
                // 获取当前缩放级别
                const zoom = myChart.getModel().getComponent('geo').coordinateSystem.getZoom();
                // 更新数据以显示/隐藏标签
                myChart.setOption({
                    geo: {
                        label: {
                            show: zoom > 2.5 // 当缩放大于3时显示地区名称
                        }
                    },
                    series: [{
                        data: getSeriesData(zoom)
                    }]
                });
                // console.log('Current Zoom Level:', zoom);
            });

            myChart.on('click', function(params) {
                console.log(params.componentType);
                if (params.componentType === 'series') {
                    // 进入 team 目录，并将文件名转为小写
                    window.location.href = "./team/" + params.name.replace(/\s+/g, '').toLowerCase() + ".html";
                } else if (params.componentType === 'geo') {
                    // 获取点击的行政区名称
                    const districtName = params.name;
                    // 查找所属的大区
                    const regionName = districtToRegionMap[districtName];
                    
                    if (regionName) {
                        // 跳转到对应大区的页面，例如 "NorthWest.html"
                        window.location.href = "./area/"+regionName.replace(/\s+/g, '') + ".html";
                    }
                }
            });
        });

    window.addEventListener('resize', myChart.resize);
</script>
<p id="data">
    从数据深入分析“英超”
</p>
<div id="radarChart">
    雷达图
</div>

<!-- Merged content from 1.html -->
<div id="radar-section-container">
    <p class="radar-subtitle">2021-2022赛季 · 20支球队完整数据对比</p>

    <div class="dashboard">
        <div class="chart-panel">
            <h2 class="section-title" id="chartTitle">曼城 - 2021-2022赛季表现雷达图</h2>
            <!-- Renamed ID to avoid conflict -->
            <div class="radar-chart-visual-container" id="radar-chart-visual"></div>
            <div class="legend" id="chartLegend"></div>

            <h3 class="section-title" style="margin-top:30px">数据明细表</h3>
            <table class="data-table" id="dataTable"></table>

            <div class="metrics-legend">
                <strong>指标说明：</strong><br>
                1. <strong>场均进球</strong>：总进球÷38场（单位：球）<br>
                2. <strong>场均射正</strong>：总射正次数÷38场（单位：次）<br>
                3. <strong>场均角球</strong>：总角球数÷38场（单位：次）<br>
                4. <strong>防守得分</strong>：10-场均失球（单位：分，失球越少分数越高）<br>
                5. <strong>零封率</strong>：零封场次占比（单位：%）<br>
                6. <strong>胜率</strong>：获胜场次占比（单位：%）
            </div>
        </div>

        <div class="controls-panel">
            <h3 class="section-title">选择俱乐部</h3>
            <div class="team-buttons" id="teamButtons"></div>

            <h3 class="section-title">可视化模式</h3>
            <label for="modeSelect"></label><select class="mode-select" id="modeSelect">
                <option value="single">单队视图</option>
                <option value="compare">两队对比</option>
            </select>

            <div id="comparisonGroup" style="display:none;margin-top:20px">
                <h3 class="section-title">对比球队</h3>
                <label for="teamASelect"></label><select class="mode-select" id="teamASelect"></select>
                <label for="teamBSelect"></label><select class="mode-select" id="teamBSelect" style="margin-top:10px"></select>
            </div>
        </div>
    </div>
</div>
<!-- D3 图表部分的 HTML 结构 -->
<div id="resultsChart">
    比赛结果
</div>

<div id="results-section-container">
    <!-- 饼图卡片 -->
    <div class="results-card">
        <div class="chart-header">比赛结果分布（主胜/平局/客胜）</div>
        <div id="chart-result" class="d3-chart-container"></div>
        <div class="hint" style="text-align: center;">交互：鼠标悬停查看具体数量与比例</div>
    </div>

    <!-- 控件卡片 -->
    <div class="results-card">
        <div class="chart-header">控制台</div>
        
        <div class="control-group">
            <span class="control-label">排序方式</span>
            <button id="sort-goals" class="btn">切换排序方式</button>
            <div class="hint">当前：按进球数降序排列</div>
        </div>

        <div class="control-group">
            <span class="control-label">图表说明</span>
            <div class="hint">
                • <strong>饼图</strong>：显示所有比赛的结果分布<br>
                • <strong>条形图</strong>：显示各队赛季总进球数<br>
                • 条形图支持两种排序方式
            </div>
        </div>
    </div>

    <!-- 条形图卡片 -->
    <div class="results-card full-width">
        <div class="chart-header">各队赛季总进球数统计</div>
        <div id="chart-goals" class="d3-chart-container" style="height: 500px"></div>
<!--        <div class="hint">说明：条形表示每个球队的赛季总进球（主场进球 + 客场进球）。鼠标悬停显示更多信息。</div>-->
    </div>
</div>

<!-- Merged content from 2.html -->
<div id="rankChartLabel">
    历史排名
</div>

<div id="rank-chart-container">
    <h1 id="rank-chart-header">英超六大豪门 2000–2022 赛季最终排名变化</h1>
    <div id="rank-chart-visual"></div>
</div>

<div class="d3-tooltip" id="d3-tooltip"></div>
<script>
    teamsData = allTeamsData;
    window.addEventListener('resize', myChart.resize);
    // --- Radar Chart Logic ---
    const radarTeamsData = {
        "曼城":{color:"#6CABDD",values:[85,87,92,95,55,76],rank:1},
        "利物浦":{color:"#C8102E",values:[92,87,85,95,55,74],rank:2},
        "切尔西":{color:"#034694",values:[68,72,78,82,42,55],rank:3},
        "热刺":{color:"#132257",values:[63,65,58,68,42,58],rank:4},
        "阿森纳":{color:"#DB0007",values:[61,63,61,71,34,58],rank:5},
        "曼联":{color:"#DA291C",values:[57,60,68,55,21,42],rank:6},
        "西汉姆联":{color:"#7A263A",values:[60,58,60,57,21,42],rank:7},
        "莱斯特城":{color:"#003090",values:[55,58,62,50,18,42],rank:8},
        "布莱顿":{color:"#0057B8",values:[45,47,55,68,34,34],rank:9},
        "狼队":{color:"#FDB913",values:[35,35,55,47,29,39],rank:10},
        "纽卡斯尔联":{color:"#241F20",values:[40,42,48,45,21,26],rank:11},
        "水晶宫":{color:"#1B458F",values:[47,45,55,58,32,29],rank:12},
        "布伦特福德":{color:"#E30613",values:[42,44,48,53,24,34],rank:13},
        "阿斯顿维拉":{color:"#95BFE5",values:[50,50,61,57,29,34],rank:14},
        "南安普顿":{color:"#D71920",values:[42,52,60,40,21,24],rank:15},
        "埃弗顿":{color:"#003399",values:[42,42,50,42,21,26],rank:16},
        "利兹联":{color:"#FFCD00",values:[41,47,48,35,13,24],rank:17},
        "伯恩利":{color:"#6C1D45",values:[30,38,50,52,24,18],rank:18},
        "沃特福德":{color:"#FFED00",values:[30,35,44,34,11,16],rank:19},
        "诺维奇":{color:"#00A650",values:[18,28,44,30,16,13],rank:20}
    };

    const indicators = [
        {name:"场均进球",max:100},
        {name:"场均射正",max:100},
        {name:"场均角球",max:100},
        {name:"防守得分",max:100},
        {name:"零封率",max:100},
        {name:"胜率",max:100}
    ];

    let radarSelected = ["曼城"], radarMode = "single", radarChartInstance = null;

    // Initialize Radar Chart
    (function initRadar(){
        const btns = document.getElementById("teamButtons");
        Object.keys(radarTeamsData).forEach(t=>{
            const b = document.createElement("button");
            b.className = "team-btn";
            b.textContent = t;
            b.style.borderLeft = `4px solid ${radarTeamsData[t].color}`;
            b.onclick = ()=>selectRadarTeam(t);
            btns.appendChild(b);
        });

        document.getElementById("modeSelect").onchange = e=>{
            radarMode = e.target.value;
            document.getElementById("comparisonGroup").style.display = radarMode==="compare"?"block":"none";
            if(radarMode==="single" && radarSelected.length>1) radarSelected = [radarSelected[0]];
            updateRadar();
        };

        const a = document.getElementById("teamASelect"), b = document.getElementById("teamBSelect");
        Object.keys(radarTeamsData).forEach(t=>{a.add(new Option(t,t)); b.add(new Option(t,t));});
        a.onchange = ()=>{radarSelected[0]=a.value; updateRadar();}
        b.onchange = ()=>{radarSelected[1]=b.value; updateRadar();}

        radarChartInstance = echarts.init(document.getElementById("radar-chart-visual"));
        window.addEventListener('resize', ()=>radarChartInstance.resize());
        
        updateRadar();
    })();

    function selectRadarTeam(t){
        if(radarMode==="single") radarSelected = [t];
        else{
            if(radarSelected.includes(t)) radarSelected = radarSelected.filter(x=>x!==t);
            else if(radarSelected.length<2) radarSelected.push(t);
            else radarSelected[1] = t; 
        }
        updateRadar();
    }

    function updateRadar(){
        document.querySelectorAll(".team-btn").forEach(b=>b.classList.toggle("active",radarSelected.includes(b.textContent)));
        if(radarSelected[0]) document.getElementById("teamASelect").value = radarSelected[0];
        if(radarSelected[1]) document.getElementById("teamBSelect").value = radarSelected[1];

        document.getElementById("chartTitle").textContent = radarMode==="single"
            ? `${radarSelected[0]} - 2021-2022赛季表现雷达图`
            : `${radarSelected[0]} vs ${radarSelected[1]} - 对比雷达图`;

        const seriesData = radarSelected.map(t=>({
            name: t,
            value: radarTeamsData[t].values,
            itemStyle: {color: radarTeamsData[t].color},
            lineStyle: {color: radarTeamsData[t].color, width: 3},
            areaStyle: {color: hexToRgba(radarTeamsData[t].color,0.25)}
        }));

        radarChartInstance.setOption({
            legend: {data: radarSelected, top:20, right:30, textStyle:{color:"#333"}},
            radar: {
                indicator: indicators,
                shape: "circle",
                center: ["50%","55%"],
                radius: "68%",
                name: {
                    color: "#000",
                    fontWeight: "bold",
                    fontSize: 14
                },
                splitArea: {areaStyle:{color:["rgba(248,249,250,0.8)","rgba(248,249,250,0.4)"]}},
                splitLine: {lineStyle:{color:"#e0e0e0"}},
                axisLine: {lineStyle:{color:"#e0e0e0"}}
            },
            series: [{type:"radar", data:seriesData}]
        }, true);

        document.getElementById("chartLegend").innerHTML = radarSelected.map(t=>`
            <div class="legend-item">
                <div class="legend-color" style="background:${radarTeamsData[t].color}"></div>
                <span>${t} (${radarTeamsData[t].rank}名)</span>
            </div>`).join("");

        const table = document.getElementById("dataTable");
        const head = `<tr><th>俱乐部</th>${indicators.map(i=>`<th>${i.name}</th>`).join("")}<th>排名</th></tr>`;
        const rows = radarSelected.map(t=>{
            const d = radarTeamsData[t];
            const cells = d.values.map(v=>`<td style="color:${v>=70?"#10b981":v>=50?"#f59e0b":"#ef4444"};font-weight:600">${v}</td>`).join("");
            return `<tr>
                <td class="team-cell"><div class="team-indicator" style="background:${d.color}"></div><strong>${t}</strong></td>
                ${cells}
                <td style="font-weight:700;color:#3b82f6">第${d.rank}名</td>
            </tr>`;
        }).join("");
        table.innerHTML = `<thead>${head}</thead><tbody>${rows}</tbody>`;
    }

    function hexToRgba(h,a){
        const r=parseInt(h.slice(1,3),16), g=parseInt(h.slice(3,5),16), b=parseInt(h.slice(5,7),16);
        return `rgba(${r},${g},${b},${a})`;
    }

    // --- D3 ---
    (function() {
        const csvFile = './statistics/2020-2021.csv';
        const colors = { H: '#2978b5', D: '#999999', A: '#f06b4a' };
        const tip = d3.select('#d3-tooltip');
        let goalsArray = [];

        function safeNum(v) { const n = +v; return isNaN(n) ? null : n; }
        function formatPct(n, total) { return ((n / total) * 100).toFixed(1) + '%'; }
        function labelFor(k) { return k === 'H' ? '主队胜' : k === 'D' ? '平局' : '客队胜'; }

        function showTooltip(html, x, y) {
            tip.style('display', 'block')
               .html(html)
               .style('left', (x + 12) + 'px')
               .style('top', (y - 28) + 'px');
        }
        function hideTooltip() { tip.style('display', 'none'); }

        d3.csv(csvFile).then(raw => {
            const data = raw.map(d => ({
                HomeTeam: d.HomeTeam, AwayTeam: d.AwayTeam,
                FTHG: safeNum(d.FTHG), FTAG: safeNum(d.FTAG), FTR: d.FTR
            }));

            // 1. Result Distribution
            const resultCounts = { H: 0, D: 0, A: 0 };
            data.forEach(d => { if (d.FTR in resultCounts) resultCounts[d.FTR]++; });
            renderResultPie(resultCounts, resultCounts.H + resultCounts.D + resultCounts.A);

            // 2. Goals by Team
            const goalsByTeam = new Map();
            data.forEach(d => {
                if (d.HomeTeam) {
                    const cur = goalsByTeam.get(d.HomeTeam) || { team: d.HomeTeam, goals: 0, matches: 0 };
                    cur.goals += (d.FTHG || 0); cur.matches += 1; goalsByTeam.set(d.HomeTeam, cur);
                }
                if (d.AwayTeam) {
                    const cur = goalsByTeam.get(d.AwayTeam) || { team: d.AwayTeam, goals: 0, matches: 0 };
                    cur.goals += (d.FTAG || 0); cur.matches += 1; goalsByTeam.set(d.AwayTeam, cur);
                }
            });
            
            goalsArray = Array.from(goalsByTeam.values());
            goalsArray.sort((a, b) => b.goals - a.goals);
            renderGoalsBar(goalsArray);

            // 3. Sort Event
            let sortByGoals = true;
            d3.select('#sort-goals').on('click', function() {
                sortByGoals = !sortByGoals;
                const arr = goalsArray.slice();
                if (sortByGoals) {
                    arr.sort((a, b) => b.goals - a.goals);
                    d3.select(this).text('按字母顺序排序');
                } else {
                    arr.sort((a, b) => a.team.localeCompare(b.team));
                    d3.select(this).text('按进球数排序');
                }
                updateGoalsBar(arr);
            });

        }).catch(err => console.error("D3 CSV Error:", err));

        function renderResultPie(counts, total) {
            const container = d3.select('#chart-result');
            container.html('');
            const w = 420, h = 300, r = Math.min(w, h) / 2 - 20;
            const svg = container.append('svg').attr('width', w).attr('height', h)
                .append('g').attr('transform', `translate(${w / 2}, ${h / 2})`);

            const pie = d3.pie().value(d => d.value)(Object.entries(counts).map(([key, value]) => ({ key, value })));
            const arc = d3.arc().innerRadius(0).outerRadius(r);

            svg.selectAll('path').data(pie).enter().append('path')
                .attr('d', arc).attr('fill', d => colors[d.data.key])
                .attr('stroke', 'white').attr('stroke-width', 1)
                .on('mousemove', (e, d) => showTooltip(`${labelFor(d.data.key)}<br>${d.data.value} 场 (${formatPct(d.data.value, total)})`, e.pageX, e.pageY))
                .on('mouseout', hideTooltip);

            svg.append('text').attr('text-anchor', 'middle').attr('dy', '-6').style('font-size', '14px').text('比赛结果');
            svg.append('text').attr('text-anchor', 'middle').attr('dy', '16').style('font-size', '12px').style('fill', '#666').text(`共 ${total} 场`);
            
            // Legend
            const legend = container.append('div').style('margin-top', '12px');
            ['H', 'D', 'A'].forEach(k => {
                const item = legend.append('div').style('display', 'inline-block').style('margin-right', '16px');
                item.append('span').style('display','inline-block').style('width','12px').style('height','12px').style('background',colors[k]).style('margin-right','6px');
                item.append('span').style('font-size','13px').text(`${labelFor(k)} ${counts[k]}`);
            });
        }

        let goalsChartState = {};

        function renderGoalsBar(data) {
            const container = d3.select('#chart-goals');
            container.html('');
            const margin = { top: 20, right: 20, bottom: 60, left: 140 };
            const cw = 1200, ch = 500;
            const svg = container.append('svg').attr('width', '100%').attr('viewBox', `0 0 ${cw} ${ch}`);

            const x = d3.scaleLinear().domain([0, d3.max(data, d => d.goals) || 1]).range([margin.left, cw - margin.right]);
            const y = d3.scaleBand().domain(data.map(d => d.team)).range([margin.top, ch - margin.bottom]).padding(0.12);

            svg.append('g').selectAll('rect').data(data).enter().append('rect')
                .attr('class', 'bar').attr('x', margin.left).attr('y', d => y(d.team))
                .attr('height', y.bandwidth()).attr('width', d => x(d.goals) - margin.left).attr('fill', '#3b82c4')
                .on('mousemove', (e, d) => showTooltip(`${d.team}<br>总进球: ${d.goals}<br>场均: ${(d.goals / d.matches).toFixed(2)}`, e.pageX, e.pageY))
                .on('mouseout', hideTooltip);

            svg.append('g').selectAll('text.team').data(data).enter().append('text')
                .attr('x', margin.left - 10).attr('y', d => y(d.team) + y.bandwidth() / 2).attr('dy', '0.35em')
                .attr('text-anchor', 'end').text(d => d.team).style('font-size', '12px');

            svg.append('g').attr('transform', `translate(0, ${ch - margin.bottom})`).call(d3.axisBottom(x).ticks(8).tickFormat(d3.format('d')));
            svg.append('text').attr('x', cw / 2).attr('y', ch - 15).attr('text-anchor', 'middle').style('font-size', '12px').style('fill', '#666').text('总进球数');

            goalsChartState = { svg, cw, ch, margin };
        }

        function updateGoalsBar(data) {
            const { svg, cw, ch, margin } = goalsChartState;
            if (!svg) return;
            svg.selectAll('*').remove();
            
            const x = d3.scaleLinear().domain([0, d3.max(data, d => d.goals) || 1]).range([margin.left, cw - margin.right]);
            const y = d3.scaleBand().domain(data.map(d => d.team)).range([margin.top, ch - margin.bottom]).padding(0.12);

            svg.append('g').selectAll('rect').data(data).enter().append('rect')
                .attr('class', 'bar').attr('x', margin.left).attr('y', d => y(d.team))
                .attr('height', y.bandwidth()).attr('width', d => x(d.goals) - margin.left).attr('fill', '#3b82c4')
                .on('mousemove', (e, d) => showTooltip(`${d.team}<br>总进球: ${d.goals}<br>场均: ${(d.goals / d.matches).toFixed(2)}`, e.pageX, e.pageY))
                .on('mouseout', hideTooltip);

            svg.append('g').selectAll('text.team').data(data).enter().append('text')
                .attr('x', margin.left - 10).attr('y', d => y(d.team) + y.bandwidth() / 2).attr('dy', '0.35em')
                .attr('text-anchor', 'end').text(d => d.team).style('font-size', '12px');

            svg.append('g').attr('transform', `translate(0, ${ch - margin.bottom})`).call(d3.axisBottom(x).ticks(8).tickFormat(d3.format('d')));
            svg.append('text').attr('x', cw / 2).attr('y', ch - 15).attr('text-anchor', 'middle').style('font-size', '12px').style('fill', '#666').text('总进球数');
        }
    })();

    // --- Rank Chart---
    (function() {
        const chartDom = document.getElementById('rank-chart-visual');
        const myChart = echarts.init(chartDom);

        const option = {
            tooltip: {
                trigger: 'axis',
                formatter: params => {
                    let str = params[0].axisValue + ' 赛季<br>';
                    params.forEach(p => {
                        str += `${p.marker} ${p.seriesName}：第 ${p.value} 名<br>`;
                    });
                    return str;
                }
            },
            legend: {
                top: 0,
                data: ['曼联', '阿森纳', '利物浦', '切尔西', '曼城', '热刺']
            },
            grid: { left: '0%', right: '0%', bottom: '5%', top: '10%', containLabel: true },
            toolbox: {
                right: 20,
                feature: {
                    saveAsImage: { title: '保存图片', pixelRatio: 2 },
                    dataZoom: {}
                }
            },
            xAxis: {
                type: 'category',
                name: '赛季起始年',
                nameLocation: 'middle',
                nameGap: 30,
                boundaryGap: false,
                axisTick: { alignWithLabel: true },
                data: ['2000','2001','2002','2003','2004','2005','2006','2007','2008','2009',
                       '2010','2011','2012','2013','2014','2015','2016','2017','2018','2019',
                       '2020','2021']
            },
            yAxis: {
                type: 'value',
                name: '联赛排名',
                 nameTextStyle: {
                    padding: [10, 10, 0, 10] 
                },
                min: 1,
                max: 21,
                interval: 1,
                inverse: true,
                axisLabel: { margin: 20 }
            },
            series: [
                { name: '曼联',   type: 'line', smooth: false, symbol: 'circle', symbolSize: 7, lineStyle: { width: 4 }, itemStyle: { color: '#da020e' },
                  data: [1,3,1,3,3,2,1,1,1,2,1,2,1,7,4,5,6,2,6,3,2,6] },
                { name: '阿森纳', type: 'line', smooth: false, symbol: 'circle', symbolSize: 7, lineStyle: { width: 4 }, itemStyle: { color: '#ef0107' },
                  data: [2,1,2,1,2,4,4,3,4,3,4,3,4,4,3,2,5,6,5,8,8,5] },
                { name: '利物浦', type: 'line', smooth: false, symbol: 'circle', symbolSize: 7, lineStyle: { width: 4 }, itemStyle: { color: '#c8102e' },
                  data: [3,2,5,4,5,3,3,4,2,7,6,8,7,2,6,8,4,4,2,1,2,2] },
                { name: '切尔西', type: 'line', smooth: false, symbol: 'circle', symbolSize: 7, lineStyle: { width: 4 }, itemStyle: { color: '#034694' },
                  data: [6,6,4,2,1,1,2,2,3,1,2,6,3,3,1,10,1,5,3,4,4,3] },
                { name: '曼城',   type: 'line', smooth: false, symbol: 'circle', symbolSize: 7, lineStyle: { width: 4 }, itemStyle: { color: '#97cbeb' },
                  data: [18,21,9,16,8,15,14,9,10,5,3,1,2,1,2,4,3,1,1,2,1,1] },
                { name: '热刺',   type: 'line', smooth: false, symbol: 'circle', symbolSize: 7, lineStyle: { width: 4 }, itemStyle: { color: '#132257' },
                  data: [12,9,10,15,9,5,5,11,8,4,5,4,5,6,5,3,2,3,4,6,7,4] }
            ]
        };

        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    })();
</script>
</body>
</html>
